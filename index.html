<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Phone</title>
    <!-- Twilio SDK -->
    <script type="text/javascript" src="https://media.twiliocdn.com/sdk/js/client/v1.14/twilio.min.js"></script>
    
    <style>
        /* iOS Design System Variables */
        :root {
            --ios-green: #34c759;
            --ios-red: #ff3b30;
            --ios-bg: #000000;
            --ios-text: #ffffff;
            --ios-gray-btn: #333333;
            --ios-gray-text: #8e8e93;
            --ios-separator: #2c2c2e;
            --ios-blue: #0a84ff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #121212;
            margin: 0;
            height: 100vh;
            color: var(--ios-text);
            display: flex;
            justify-content: center;
            overflow: hidden;
        }

        /* Phone Container */
        #app {
            width: 100%;
            max-width: 420px;
            height: 100%;
            background-color: var(--ios-bg);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* --- Views (Tabs) --- */
        .view {
            flex: 1;
            display: none;
            flex-direction: column;
            padding-bottom: 80px; /* Space for tab bar */
        }
        .view.active { display: flex; }

        /* --- Keypad View --- */
        #display-area {
            height: 15vh;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 10px;
            position: relative;
        }

        #phone-input {
            background: transparent;
            border: none;
            color: white;
            font-size: 40px;
            text-align: center;
            width: 80%;
            outline: none;
            font-weight: 300;
        }

        /* The Grid */
        .keypad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            padding: 0 40px;
            justify-items: center;
            margin-top: 10px;
        }

        .key-btn {
            width: 75px;
            height: 75px;
            border-radius: 50%;
            background-color: var(--ios-gray-btn);
            border: none;
            color: white;
            font-size: 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .key-btn:active { background-color: #555; }
        
        .key-sub {
            font-size: 10px;
            font-weight: bold;
            margin-top: -5px;
            letter-spacing: 2px;
            color: white;
        }

        .call-btn {
            background-color: var(--ios-green);
            width: 75px;
            height: 75px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            margin-top: 20px;
        }
        .call-btn:active { opacity: 0.8; }

        /* Backspace logic */
        #backspace-btn {
            position: absolute;
            right: 40px;
            bottom: 25px;
            background: transparent;
            border: none;
            color: var(--ios-gray-text);
            cursor: pointer;
            display: none; /* Hidden when empty */
        }

        /* --- Recents View --- */
        #recents-view { background: var(--ios-bg); }
        
        .header {
            padding: 50px 20px 10px 20px;
            font-size: 34px;
            font-weight: bold;
        }

        .recent-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--ios-separator);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .recent-item:active { background-color: #1c1c1e; }
        .recent-info { display: flex; flex-direction: column; }
        .recent-num { font-size: 17px; font-weight: 600; margin-bottom: 4px; }
        .recent-time { font-size: 14px; color: var(--ios-gray-text); }
        .info-icon { color: var(--ios-blue); font-size: 20px; }

        /* --- In-Call Overlay --- */
        #incall-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(20, 30, 40, 0.95);
            backdrop-filter: blur(10px);
            z-index: 100;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            padding: 60px 20px;
        }
        .caller-status { color: var(--ios-gray-text); font-size: 18px; }
        .caller-number { font-size: 36px; margin-top: 10px; }
        
        .hangup-btn {
            background-color: var(--ios-red);
            width: 75px;
            height: 75px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
        }

        /* --- Tab Bar --- */
        #tab-bar {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 80px;
            background-color: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            border-top: 1px solid var(--ios-separator);
            padding-top: 10px;
        }

        .tab-btn {
            background: none;
            border: none;
            color: var(--ios-gray-text);
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 10px;
            cursor: pointer;
        }
        
        .tab-btn.active { color: var(--ios-blue); }
        .tab-icon { font-size: 24px; margin-bottom: 4px; }

        /* Status Bar logic */
        #system-status {
            position: absolute;
            top: 0;
            width: 100%;
            text-align: center;
            font-size: 12px;
            padding: 5px;
            color: var(--ios-gray-text);
            background: rgba(0,0,0,0.5);
            z-index: 50;
        }
    </style>
</head>
<body>

<div id="app">
    <div id="system-status">Initializing...</div>

    <!-- RECENT CALLS TAB -->
    <div id="recents-view" class="view">
        <div class="header">Recents</div>
        <div id="recents-list">
            <!-- JS will populate this -->
            <div style="padding: 20px; color: #555;">No recent calls</div>
        </div>
    </div>

    <!-- KEYPAD TAB -->
    <div id="keypad-view" class="view active">
        <!-- Display / Input -->
        <div id="display-area">
            <input type="tel" id="phone-input" placeholder="" autocomplete="off">
            <button id="backspace-btn" onclick="backspace()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path>
                    <line x1="18" y1="9" x2="12" y2="15"></line>
                    <line x1="12" y1="9" x2="18" y2="15"></line>
                </svg>
            </button>
        </div>

        <!-- Buttons -->
        <div class="keypad-grid">
            <button class="key-btn" onclick="press('1')">1<div class="key-sub">&nbsp;</div></button>
            <button class="key-btn" onclick="press('2')">2<div class="key-sub">ABC</div></button>
            <button class="key-btn" onclick="press('3')">3<div class="key-sub">DEF</div></button>
            
            <button class="key-btn" onclick="press('4')">4<div class="key-sub">GHI</div></button>
            <button class="key-btn" onclick="press('5')">5<div class="key-sub">JKL</div></button>
            <button class="key-btn" onclick="press('6')">6<div class="key-sub">MNO</div></button>
            
            <button class="key-btn" onclick="press('7')">7<div class="key-sub">PQRS</div></button>
            <button class="key-btn" onclick="press('8')">8<div class="key-sub">TUV</div></button>
            <button class="key-btn" onclick="press('9')">9<div class="key-sub">WXYZ</div></button>
            
            <button class="key-btn" onclick="press('*')">*</button>
            <button class="key-btn" onclick="press('0')">0<div class="key-sub">+</div></button>
            <button class="key-btn" onclick="press('#')">#</button>
        </div>

        <div style="display:flex; justify-content:center;">
            <button class="call-btn" onclick="startCall()">
                <svg width="35" height="35" viewBox="0 0 24 24" fill="white">
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- IN CALL OVERLAY -->
    <div id="incall-overlay">
        <div style="text-align:center;">
            <div style="width:80px; height:80px; background:#555; border-radius:50%; margin:0 auto 20px auto; display:flex; align-items:center; justify-content:center;">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="1">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
            </div>
            <div class="caller-status" id="call-status-text">Calling...</div>
            <div class="caller-number" id="incall-number">...</div>
        </div>

        <button class="hangup-btn" onclick="endCall()">
            <svg width="35" height="35" viewBox="0 0 24 24" fill="white" style="transform: rotate(135deg);">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
            </svg>
        </button>
    </div>

    <!-- BOTTOM TABS -->
    <div id="tab-bar">
        <button class="tab-btn" id="tab-recents" onclick="switchTab('recents')">
            <span class="tab-icon">üïí</span>
            Recents
        </button>
        <button class="tab-btn active" id="tab-keypad" onclick="switchTab('keypad')">
            <span class="tab-icon">#Ô∏è‚É£</span>
            Keypad
        </button>
    </div>
</div>

<script>
    /* --- LOGIC --- */
    const input = document.getElementById('phone-input');
    const backspaceBtn = document.getElementById('backspace-btn');
    const statusDiv = document.getElementById('system-status');
    let device;

    // 1. INPUT HANDLING
    function press(key) {
        input.value += key;
        updateUI();
    }

    function backspace() {
        input.value = input.value.slice(0, -1);
        updateUI();
    }
    
    // Listen for manual typing/pasting
    input.addEventListener('input', updateUI);

    function updateUI() {
        // Show/Hide backspace
        if(input.value.length > 0) {
            backspaceBtn.style.display = 'block';
        } else {
            backspaceBtn.style.display = 'none';
        }
    }

    // 2. TAB SWITCHING
    function switchTab(tabName) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        
        document.getElementById(tabName + '-view').classList.add('active');
        document.getElementById('tab-' + tabName).classList.add('active');

        if(tabName === 'recents') loadRecents();
    }

    // 3. TWILIO SETUP
    async function setupPhone() {
        statusDiv.innerText = 'Connecting to Twilio...';
        try {
            // Netlify function call
            const response = await fetch('/.netlify/functions/token');
            const data = await response.json();
            
            Twilio.Device.setup(data.token);

            Twilio.Device.ready(function(device) {
                statusDiv.innerText = 'Online';
                statusDiv.style.color = '#34c759';
            });

            Twilio.Device.error(function(error) {
                console.error(error);
                statusDiv.innerText = 'Error: ' + error.message;
            });
            
            Twilio.Device.disconnect(function() {
                endCallUI();
            });

        } catch (e) {
            statusDiv.innerText = 'System Error';
        }
    }

    // 4. CALL LOGIC
    function startCall() {
        const number = input.value;
        if(!number) return;

        // Save to history
        saveRecent(number);

        // UI Changes
        document.getElementById('incall-overlay').style.display = 'flex';
        document.getElementById('incall-number').innerText = number;
        document.getElementById('call-status-text').innerText = 'Calling...';

        // Twilio Connect
        const params = { To: number };
        Twilio.Device.connect(params);
    }

    function endCall() {
        Twilio.Device.disconnectAll();
        endCallUI();
    }

    function endCallUI() {
        document.getElementById('incall-overlay').style.display = 'none';
        input.value = ""; // Clear input after call
        updateUI();
    }

    // 5. HISTORY (LOCAL STORAGE)
    function saveRecent(number) {
        let history = JSON.parse(localStorage.getItem('callHistory') || "[]");
        const now = new Date();
        const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        // Add to top of list
        history.unshift({ number: number, time: timeString, date: now.toLocaleDateString() });
        
        // Keep only last 20
        if(history.length > 20) history.pop();
        
        localStorage.setItem('callHistory', JSON.stringify(history));
    }

    function loadRecents() {
        const list = document.getElementById('recents-list');
        const history = JSON.parse(localStorage.getItem('callHistory') || "[]");
        
        if(history.length === 0) {
            list.innerHTML = '<div style="padding:20px; text-align:center; color:#555;">No recent calls</div>';
            return;
        }

        list.innerHTML = '';
        history.forEach(item => {
            const div = document.createElement('div');
            div.className = 'recent-item';
            div.onclick = () => {
                // Tap recent to call
                switchTab('keypad');
                input.value = item.number;
                updateUI();
            };
            div.innerHTML = `
                <div class="recent-info">
                    <span class="recent-num">${item.number}</span>
                    <span class="recent-time">${item.date} ${item.time}</span>
                </div>
                <div class="info-icon">‚ìò</div>
            `;
            list.appendChild(div);
        });
    }

    // Start
    setupPhone();

</script>
</body>
</html>
